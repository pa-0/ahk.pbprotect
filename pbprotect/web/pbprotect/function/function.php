<?php


// #####################################################################
// #####################################################################
// ###########   G E T   R E M O T E   I P   A D D R E S S   ###########
// #####################################################################
// #####################################################################

// =====================================================================
// Function to get the remote ip address.
// =====================================================================
function get_remote_ip() {


  // ===================================================================
  // Initialize the ip address variable.
  // ===================================================================
  $ip_address = "-";


  // ===================================================================
  // Check if the 'SERVER' array is available.
  // ===================================================================
  if (isset($_SERVER)) {


    // =================================================================
    // Check if the 'HTTP_X_FORWARDED_FOR' variable is available.
    // =================================================================
    if (isset($_SERVER["HTTP_X_FORWARDED_FOR"])) {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_SERVER["HTTP_X_FORWARDED_FOR"];


      // ===============================================================
      // Check if the 'HTTP_CLIENT_IP' variable is available.
      // ===============================================================
    } elseif (isset($_SERVER["HTTP_CLIENT_IP"])) {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_SERVER["HTTP_CLIENT_IP"];


      // ===============================================================
      // Use the 'REMOTE_ADDR' variable
      // ===============================================================
    } else {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_SERVER["REMOTE_ADDR"];
    }


    // =================================================================
    // Check if the 'ENV' array is available.
    // =================================================================
  } elseif (isset($_ENV)) {


    // =================================================================
    // Check if the 'HTTP_X_FORWARDED_FOR' variable is available.
    // =================================================================
    if (isset($_ENV['HTTP_X_FORWARDED_FOR'])) {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_ENV["HTTP_X_FORWARDED_FOR"];


      // ===============================================================
      // Check if the 'HTTP_CLIENT_IP' variable is available.
      // ===============================================================
    } elseif (isset($_ENV["HTTP_CLIENT_IP"])) {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_ENV["HTTP_CLIENT_IP"];


      // ===============================================================
      // Use the 'REMOTE_ADDR' variable
      // ===============================================================
    } else {


      // ===============================================================
      // Store the ip address.
      // ===============================================================
      $ip_address = $_ENV["REMOTE_ADDR"];
    }
  } // Check if the 'ENV' array is available.


  // ===================================================================
  // Check if an ip address was found.
  // ===================================================================
  if ($ip_address != "-") {


    // =================================================================
    // Check if the ip address is not valid.
    // =================================================================
    if (!preg_match('/\A(?:\b(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\b)\Z/im', $ip_address)) {


      // ===============================================================
      // Specift that the address is not valid.
      // ===============================================================
      $ip_address = "!";
    }
  }


  // ===================================================================
  // Return the ip address.
  // ===================================================================
  return $ip_address;
}
