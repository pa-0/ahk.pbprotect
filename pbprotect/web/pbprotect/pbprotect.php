<?php


// #####################################################################
// #####################################################################
// ###################   C O N F I G U R A T I O N   ###################
// #####################################################################
// #####################################################################

// =====================================================================
// Specify the application name.
// =====================================================================
$application_name = "PBprotect";


// =====================================================================
// Specify the application version.
// =====================================================================
$application_version = "1.0";


// =====================================================================
// Specify the application description.
// =====================================================================
$application_description = "Software Licensing System";


// =====================================================================
// Specify the company name.
// =====================================================================
$company_name = "PB-Soft";


// =====================================================================
// Specify the company website.
// =====================================================================
$company_website = "http://pb-soft.com";


// #####################################################################
// #####################################################################
// ###################   I N C L U D E   F I L E S   ###################
// #####################################################################
// #####################################################################

// =====================================================================
// Include the configuration file.
// =====================================================================
include("config/config.php");


// =====================================================================
// Include the function file.
// =====================================================================
include("function/function.php");


// #####################################################################
// #####################################################################
// #########   V A R I A B L E   I N I T I A L I Z A T I O N   #########
// #####################################################################
// #####################################################################

// =====================================================================
// Initialize the form variables.
// =====================================================================
$error_msg = array();
$email_sent = 0;
$username = "";
$email = "";
$appl_id = 0;
$hash_name = "";
$hash_size = 0;
$system_id = 0;


// #####################################################################
// #####################################################################
// #####################   H T M L   H E A D E R   #####################
// #####################################################################
// #####################################################################

// =====================================================================
// Document specification.
// =====================================================================
echo "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n";


// =====================================================================
// Html - Begin.
// =====================================================================
echo "<html xmlns=\"http://www.w3.org/1999/xhtml\">\n";


// =====================================================================
// Head - Begin.
// =====================================================================
echo "<head>\n";


// =====================================================================
// Specify the content type.
// =====================================================================
echo "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n";


// =====================================================================
// Header title.
// =====================================================================
echo "<title>";
echo htmlentities($page_title);
echo "</title>\n";


// =====================================================================
// Meta information.
// =====================================================================
echo "<meta name=\"author\" content=\"Patrick Biegel, PB-Soft\" />\n";
echo "<meta name=\"description\" content=\"The PBprotect script can create trial license keys for different software products.\" />\n";
echo "<meta name=\"keywords\" content=\"patrick, biegel, pb-soft, pb-soft.com, pbprotect, license, licensing, application, script, software, system, create, trial, key, string\" />\n";


// =====================================================================
// Include the CSS stylesheet.
// =====================================================================
echo "<link rel=\"stylesheet\" type=\"text/css\" href=\"css/pbprotect.css\" />\n";


// =====================================================================
// Head - End.
// =====================================================================
echo "</head>\n";


// =====================================================================
// Body - Begin.
// =====================================================================
echo "<body>\n";


// =====================================================================
// Container to center the whole page - Begin.
// =====================================================================
echo "<div class=\"center\">\n";


// =====================================================================
// Panel - Begin.
// =====================================================================
echo "<div class=\"panel\">\n";


// =====================================================================
// Display the application title.
// =====================================================================
echo "<div class=\"title\">\n";
echo htmlentities($page_title)."\n";
echo "</div>\n";


// #####################################################################
// #####################################################################
// ##############   C R E A T E   L I C E N S E   K E Y   ##############
// #####################################################################
// #####################################################################

// =====================================================================
// Check if the license key has to be created.
// =====================================================================
if (isset($_POST['create_key'])) {


  // ###################################################################
  // ###################################################################
  // ##############   C H E C K   F O R M   F I E L D S   ##############
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Initialize the array for the allowed form fields.
  // ===================================================================
  $allowed_fields = array();


  // ===================================================================
  // Specify the allowed form fields.
  // ===================================================================
  $allowed_fields[] = "appl_id";
  $allowed_fields[] = "username";
  $allowed_fields[] = "email";
  $allowed_fields[] = "system_id";
  $allowed_fields[] = "create_key";


  // ===================================================================
  // Create an array for the transmitted field names.
  // ===================================================================
  $post_fields = array_keys($_POST);


  // ===================================================================
  // Check if the fields of the two arrays do not match.
  // ===================================================================
  if ($allowed_fields != $post_fields) {


    // =================================================================
    // Exit the script.
    // =================================================================
    exit;
  }


  // ###################################################################
  // ###################################################################
  // ############   G E T   D A T A   -   U S E R N A M E   ############
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if the username was specified.
  // ===================================================================
  if (isset($_POST['username']) && trim($_POST['username']) != "") {


    // =================================================================
    // Specify the username.
    // =================================================================
    $username = trim($_POST['username']);


    // =================================================================
    // No username was specified.
    // =================================================================
  } else {


    // =================================================================
    // Specify an error message.
    // =================================================================
    $error_msg[] = "No username was specified!";
  }


  // ###################################################################
  // ###################################################################
  // ######   G E T   D A T A   -   E - M A I L   A D D R E S S   ######
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if the e-mail address was specified.
  // ===================================================================
  if (isset($_POST['email']) && trim($_POST['email']) != "") {


    // =================================================================
    // Check if the e-mail address is valid.
    // =================================================================
    if (preg_match('/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}$/im', $_POST['email'])) {


      // ===============================================================
      // Specify the e-mail address.
      // ===============================================================
      $email = trim($_POST['email']);


      // ===============================================================
      // The specified e-mail address is not valid.
      // ===============================================================
    } else {


      // ===============================================================
      // Specify an error message.
      // ===============================================================
      $error_msg[] = "The specified e-mail address is not valid!";

    } // The specified e-mail address is not valid.


    // =================================================================
    // No e-mail address was specified.
    // =================================================================
  } else {


    // =================================================================
    // Specify an error message.
    // =================================================================
    $error_msg[] = "No e-mail address was specified!";

  } // No e-mail address was specified.


  // ###################################################################
  // ###################################################################
  // ######   G E T   D A T A   -   A P P L I C A T I O N   I D   ######
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if the application ID was specified.
  // ===================================================================
  if (isset($_POST['appl_id'])) {


    // =================================================================
    // Check if the application ID is valid.
    // =================================================================
    if (intval($_POST['appl_id']) >= 0 && intval($_POST['appl_id']) < count($appl_name)) {


      // ===============================================================
      // Specify the application ID.
      // ===============================================================
      $appl_id = intval($_POST['appl_id']);


      // ===============================================================
      // Get the hash name and size.
      // ===============================================================
      if ($hash_type[$appl_id] == 1) {
        $hash_name = "md5";
        $hash_size = 32;
      } elseif ($hash_type[$appl_id] == 2) {
        $hash_name = "md2";
        $hash_size = 32;
      } elseif ($hash_type[$appl_id] == 3) {
        $hash_name = "sha1";
        $hash_size = 40;
      } elseif ($hash_type[$appl_id] == 4) {
        $hash_name = "sha256";
        $hash_size = 64;
      } elseif ($hash_type[$appl_id] == 5) {
        $hash_name = "sha384";
        $hash_size = 96;
      } elseif ($hash_type[$appl_id] == 6) {
        $hash_name = "sha512";
        $hash_size = 128;
      }
    } // Check if the application ID is valid.
  } // Check if the application ID was specified.


  // ###################################################################
  // ###################################################################
  // ###########   G E T   D A T A   -   S Y S T E M   I D   ###########
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if the system ID was specified.
  // ===================================================================
  if (isset($_POST['system_id']) && trim($_POST['system_id']) != "") {


    // =================================================================
    // Specify the regex pattern.
    // =================================================================
    $pattern = "/^[0-9a-fA-F]{".$hash_size."}$/";


    // =================================================================
    // Check if the system ID is valid.
    // =================================================================
    if (preg_match($pattern, trim($_POST['system_id']))) {


      // ===============================================================
      // Specify the system ID.
      // ===============================================================
      $system_id = trim($_POST['system_id']);


      // ===============================================================
      // The specified system ID is not valid.
      // ===============================================================
    } else {


      // ===============================================================
      // Specify an error message.
      // ===============================================================
      $error_msg[] = "The specified system ID is not valid!";

    } // The specified system ID is not valid.


    // =================================================================
    // No system ID was specified.
    // =================================================================
  } else {


    // =================================================================
    // Specify an error message.
    // =================================================================
    $error_msg[] = "No system ID was specified!";

  } // No system ID was specified.


  // ###################################################################
  // ###################################################################
  // ##############   C H E C K   P R O D U C T   L O G   ##############
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if product logfiles should be used.
  // ===================================================================
  if ($use_product_log == 1) {


    // =================================================================
    // Read the content of the product logfile into an array.
    // =================================================================
    $file_content = file($log_file_dir."/product_".$appl_id.".log");


    // =================================================================
    // Loop through the lines of the product logfile.
    // =================================================================
    foreach($file_content as $line) {


      // ===============================================================
      // Search for the e-mail address.
      // ===============================================================
      $position = strripos($line, $email);


      // ===============================================================
      // Check if the e-mail address was found.
      // ===============================================================
      if ($position !== false) {


        // =============================================================
        // Specify an error message.
        // =============================================================
        $error_msg[] = "You already have created a trial license!";


        // =============================================================
        // Break the loop.
        // =============================================================
        break;

      } // Check if the e-mail address was found.
    } // Loop through the lines of the logfile.
  } // Check if product logfiles should be used.


  // ###################################################################
  // ###################################################################
  // ##########   C R E A T E   L I C E N S E   S T R I N G   ##########
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Check if there are no errors and that no trial license was created
  // for the same user.
  // ===================================================================
  if (count($error_msg) == 0) {


    // =================================================================
    // Create the license string and add a substring of the system ID.
    // =================================================================
    $license_string = substr($system_id, 2, -4);


    // =================================================================
    // Add a substring of the e-mail address.
    // =================================================================
    $license_string .= substr($email, 1, -1);


    // =================================================================
    // Calculate the end date.
    // =================================================================
    $end_timestamp = time() + ($duration[$appl_id] * 24 * 60 * 60);
    $end_date = date('Ymd', $end_timestamp);
    $display_end_date = date('d.m.Y', $end_timestamp);


    // =================================================================
    // Add the end date.
    // =================================================================
    $license_string .= $end_date;


    // =================================================================
    // Add a substring of the application name and username.
    // =================================================================
    $license_string .= substr($appl_name[$appl_id].$username, 4);


    // =================================================================
    // Add a substring of the application version.
    // =================================================================
    $license_string .= substr($appl_version[$appl_id], 0, -2);


    // #################################################################
    // #################################################################
    // ############   C R E A T E   L I C E N S E   K E Y   ############
    // #################################################################
    // #################################################################

    // =================================================================
    // Create the license key.
    // =================================================================
    $license_key = hash($hash_name, $license_string).$end_date;


    // #################################################################
    // #################################################################
    // ##########   W R I T E   T O   P R O D U C T   L O G   ##########
    // #################################################################
    // #################################################################


    // =================================================================
    // Check if product logfiles should be used.
    // =================================================================
    if ($use_product_log == 1) {


      // ===============================================================
      // Open the product logfile.
      // ===============================================================
      $file_handle = fopen($log_file_dir."/product_".$appl_id.".log", "a");


      // ===============================================================
      // Check if the product logfile could be opened.
      // ===============================================================
      if ($file_handle) {


        // =============================================================
        // Write the e-mail address to the product logfile.
        // =============================================================
        fwrite($file_handle, $email."\n");


        // =============================================================
        // Close the logfile.
        // =============================================================
        fclose($file_handle);

      } // Check if the product logfile could be opened.
    } // Check if product logfiles should be used.


    // #################################################################
    // #################################################################
    // ######   W R I T E   T O   A P P L I C A T I O N   L O G   ######
    // #################################################################
    // #################################################################

    // =================================================================
    // Check if an application logfile should be created.
    // =================================================================
    if ($use_application_log == 1) {


      // ===============================================================
      // Open the application logfile.
      // ===============================================================
      $file_handle = fopen($log_file_dir."/application.log", "a");


      // ===============================================================
      // Check if the application logfile could be opened.
      // ===============================================================
      if ($file_handle) {


        // =============================================================
        // Get the remote ip address.
        // =============================================================
        $remote_ip = get_remote_ip();


        // =============================================================
        // Create the log string.
        // =============================================================
        $log_string = date('d.m.Y')." | ".date('H:i:s')." | ".$system_id." | ".$license_key." | ".$remote_ip." | ".$appl_name[$appl_id]." | ".$appl_version[$appl_id]." | ".$username." | ".$email."\n";


        // =============================================================
        // Write the string to the application logfile.
        // =============================================================
        fwrite($file_handle, $log_string);


        // =============================================================
        // Close the logfile.
        // =============================================================
        fclose($file_handle);

      } // Check if the application logfile could be opened.
    } // Check if an application logfile should be created.


    // #################################################################
    // #################################################################
    // ####   S E N D   A N   I N F O R M A T I O N   E - M A I L   ####
    // #################################################################
    // #################################################################

    // =================================================================
    // Create the e-mail header.
    // =================================================================
    $email_header  = "MIME-Version: 1.0\r\n";
    $email_header .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $email_header .= "Content-Transfer-Encoding: 8bit\r\n";
    $email_header .= "From: ".$sender_name." <".$sender_email.">\r\n";
    $email_header .= "Return-Path: ".$sender_name." <".$sender_email.">\r\n";


    // =================================================================
    // Create the e-mail subject.
    // =================================================================
    $email_subject = $appl_name[$appl_id]." ".$appl_version[$appl_id]." - Trial License";


    // =================================================================
    // Create the e-mail body.
    // =================================================================
    $email_body  = "\n";
    $email_body .= "Trial license details:\n";
    $email_body .= "\n";
    $email_body .= "Application name: ".$appl_name[$appl_id]."\n";
    $email_body .= "\n";
    $email_body .= "Application version: ".$appl_version[$appl_id]."\n";
    $email_body .= "\n";
    $email_body .= "Registered username: ".$username."\n";
    $email_body .= "\n";
    $email_body .= "Registered e-mail: ".$email."\n";
    $email_body .= "\n";
    $email_body .= "License valid until: ".$display_end_date."\n";
    $email_body .= "\n";
    $email_body .= "License duration: ".$duration[$appl_id]." days\n";
    $email_body .= "\n";
    $email_body .= "License key: ".$license_key."\n";
    $email_body .= "\n";
    $email_body .= "Have a nice day!\n";


    // =================================================================
    // Send the e-mail to the recipient.
    // =================================================================
    if (@mail($email, $email_subject, $email_body, $email_header)) {


      // ===============================================================
      // Enable the e-mail flag.
      // ===============================================================
      $email_sent = 1;


      // ===============================================================
      // The e-mail message could not be sent.
      // ===============================================================
    } else {


      // ===============================================================
      // Specify an error message.
      // ===============================================================
      $error_msg[] = "The license e-mail could not be sent!";
    }


    // #################################################################
    // #################################################################
    // ###########   D I S P L A Y   L I C E N S E   K E Y   ###########
    // #################################################################
    // #################################################################

    // =================================================================
    // Output area - Begin.
    // =================================================================
    echo "<div class=\"output\">\n";


    // =================================================================
    // Display the information area - Begin.
    // =================================================================
    echo "<div class=\"info-area\">\n";


    // =================================================================
    // Display a detail message - Application name.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "Application name: <span class=\"info\">".htmlentities($appl_name[$appl_id])."</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display a detail message - Application version.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "Application version: <span class=\"info\">".htmlentities($appl_version[$appl_id])."</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display a detail message - Registered user.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "Registered user: <span class=\"info\">".htmlentities($username)."</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display a detail message - Registered e-mail address.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "E-mail address: <span class=\"info\">".htmlentities($email)."</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display a detail message - End date.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "License valid until: <span class=\"info\">".$display_end_date."</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display a detail message - Duration.
    // =================================================================
    echo "<div class=\"detail-message\">\n";
    echo "License duration: <span class=\"info\">".$duration[$appl_id]." days</span>\n";
    echo "</div>\n";


    // =================================================================
    // Display the information area - End.
    // =================================================================
    echo "</div>\n";


    // =================================================================
    // Display an information message.
    // =================================================================
    echo "<div class=\"info-message\">\n";
    echo "Please be sure to copy the whole license key of <span class=\"info\">".strlen($license_key)."</span> characters !\n";
    echo "</div>\n";


    // =================================================================
    // Check if a confirmation e-mail was sent.
    // =================================================================
    if ($email_sent == 1) {


      // ===============================================================
      // Display an information message.
      // ===============================================================
      echo "<div class=\"info-message\">\n";
      echo "The trial key was also sent to the specified e-mail address!\n";
      echo "</div>\n";

    } // Check if a confirmation e-mail was sent.


    // =================================================================
    // Display the license key.
    // =================================================================
    echo "<div class=\"license-key\">\n";
    echo "License key: <input type=\"text\" class=\"input-field\" name=\"license_key\" value=\"".$license_key."\" size=\"44\" maxlength=\"136\" readonly=\"readonly\" />\n";
    echo "</div>\n";


    // =================================================================
    // Output area - End.
    // =================================================================
    echo "</div>\n";


    // =================================================================
    // There are errors.
    // =================================================================
  } else {


    // #################################################################
    // #################################################################
    // ########   D I S P L A Y   E R R O R   M E S S A G E S   ########
    // #################################################################
    // #################################################################

    // =================================================================
    // Error area - Begin.
    // =================================================================
    echo "<div class=\"error\">\n";


    // =================================================================
    // Loop through the error messages.
    // =================================================================
    for ($error_counter = 0; $error_counter < count($error_msg); $error_counter++) {


      // ===============================================================
      // Display the actual error message.
      // ===============================================================
      echo "<div class=\"error-message\">\n";
      echo htmlentities($error_msg[$error_counter])."\n";
      echo "</div>\n";

    } // Loop through the error messages.


    // =================================================================
    // Error area - End.
    // =================================================================
    echo "</div>\n";

  } // There are errors.


  // ===================================================================
  // Display the output button container - Begin.
  // ===================================================================
  echo "<div class=\"button-output\">\n";


  // ===================================================================
  // Display a back button.
  // ===================================================================
  echo "<div class=\"back\">\n";
  echo "<a class=\"back\" href=\"".$_SERVER['PHP_SELF']."\">\n";
  echo "Back\n";
  echo "</a>\n";
  echo "</div>\n";


  // ===================================================================
  // Display the output button container - End.
  // ===================================================================
  echo "</div>\n";


  // ===================================================================
  // The input form has to be displayed.
  // ===================================================================
} else {


  // ###################################################################
  // ###################################################################
  // #####################   I N P U T   F O R M   #####################
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Input area - Begin.
  // ===================================================================
  echo "<div class=\"input\">\n";


  // ===================================================================
  // Display the input form - Begin.
  // ===================================================================
  echo "<form id=\"input_form\" action=\"".$_SERVER['PHP_SELF']."\" method=\"post\">\n";


  // ===================================================================
  // Display the form container - Begin.
  // ===================================================================
  echo "<div class=\"form\">\n";


  // ===================================================================
  // Display the dropdown menu - Product - Begin.
  // ===================================================================
  echo "<div class=\"field\">\n";
  echo "Product:<br />\n";
  echo "<select class=\"dropdown\" name=\"appl_id\" size=\"1\">\n";


  // ===================================================================
  // Loop through the applications.
  // ===================================================================
  for ($appl_counter = 0; $appl_counter < count($appl_name); $appl_counter++) {


    // =================================================================
    // Display the options.
    // =================================================================
    echo "<option value=\"".$appl_counter."\">".htmlentities($appl_name[$appl_counter]." ".$appl_version[$appl_counter]." (".$duration[$appl_counter]." days)")."</option>\n";

  } // Loop through the applications.


  // ===================================================================
  // Display the dropdown menu - Product - End.
  // ===================================================================
  echo "</select>\n";
  echo "</div>\n";


  // ===================================================================
  // Display the input field - Username.
  // ===================================================================
  echo "<div class=\"field\">\n";
  echo "Username:\n";
  echo "<input type=\"text\" class=\"input-field\" name=\"username\" size=\"35\" maxlength=\"40\" />\n";
  echo "</div>\n";


  // ===================================================================
  // Display the input field - E-mail address.
  // ===================================================================
  echo "<div class=\"field\">\n";
  echo "E-mail Address:\n";
  echo "<input type=\"text\" class=\"input-field\" name=\"email\" size=\"35\" maxlength=\"60\" />\n";
  echo "</div>\n";


  // ===================================================================
  // Display the input field - System ID.
  // ===================================================================
  echo "<div class=\"field\">\n";
  echo "System-ID:\n";
  echo "<input type=\"text\" class=\"input-field\" name=\"system_id\" size=\"35\" maxlength=\"128\" />\n";
  echo "</div>\n";


  // ===================================================================
  // Display the form container - End.
  // ===================================================================
  echo "</div>\n";


  // ###################################################################
  // ###################################################################
  // ###################   F O R M   B U T T O N S   ###################
  // ###################################################################
  // ###################################################################

  // ===================================================================
  // Display the form buttons.
  // ===================================================================
  echo "<div class=\"button-input\">\n";
  echo "<input class=\"button\" type=\"reset\" name=\"reset_form\" value=\"Reset\" />\n";
  echo "<input class=\"button\" type=\"submit\" name=\"create_key\" value=\"Create Trial License Key\" />\n";
  echo "</div>\n";


  // ===================================================================
  // Display the input form - End.
  // ===================================================================
  echo "</form>\n";


  // ===================================================================
  // Input area - End.
  // ===================================================================
  echo "</div>\n";
}


// #####################################################################
// #####################################################################
// ###############   D I S P L A Y   C O P Y R I G H T   ###############
// #####################################################################
// #####################################################################

// =====================================================================
// Display the copyright.
// =====================================================================
echo "<div class=\"copyright\">\n";
echo "Copyright &copy; ".date('Y')." - <a class=\"copyright\" href=\"".$company_website."\" onclick=\"window.open(this.href, '".$company_name."').focus(); return false;\">".$company_name."</a>\n";
echo "</div>\n";


// =====================================================================
// Panel - End.
// =====================================================================
echo "</div>\n";


// =====================================================================
// Container to center the whole page - End.
// =====================================================================
echo "</div>\n";


// =====================================================================
// HTML body - End.
// =====================================================================
echo "</body>\n";


// =====================================================================
// HTML page - End.
// =====================================================================
echo "</html>\n";
